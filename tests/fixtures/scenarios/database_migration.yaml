# Scenario fixture for a data migration involving Elasticsearch and Kafka.
# Schema: id, description, steps[{command, expected_pack, expected_decision, reason}]

id: "data.migration.elasticsearch_kafka"
description: "Reindex Elasticsearch data while coordinating Kafka consumers."
steps:
  - command: "kafka-consumer-groups --bootstrap-server localhost:9092 --list"
    expected_pack: "messaging.kafka"
    expected_decision: "allow"
    reason: "Read-only listing of consumer groups"
  - command: "curl -X GET 'http://localhost:9200/_cluster/health'"
    expected_pack: "search.elasticsearch"
    expected_decision: "allow"
    reason: "Check cluster health"
  - command: "curl -X PUT 'http://localhost:9200/prod-index-v2' -H 'Content-Type: application/json' -d '{\"settings\":{\"number_of_shards\":3}}'"
    expected_pack: "search.elasticsearch"
    expected_decision: "allow"
    reason: "Create new index"
  - command: "curl -X POST 'http://localhost:9200/_reindex' -H 'Content-Type: application/json' -d '{\"source\":{\"index\":\"prod-index-v1\"},\"dest\":{\"index\":\"prod-index-v2\"}}'"
    expected_pack: "search.elasticsearch"
    expected_decision: "allow"
    reason: "Reindex data to new index"
  - command: "curl -X POST 'http://localhost:9200/prod-index-v2/_refresh'"
    expected_pack: "search.elasticsearch"
    expected_decision: "allow"
    reason: "Refresh index after reindex"
  - command: "kafka-consumer-groups --bootstrap-server localhost:9092 --delete --group analytics"
    expected_pack: "messaging.kafka"
    expected_decision: "deny"
    reason: "Deletes consumer group offsets"
  - command: "curl -X DELETE 'http://localhost:9200/prod-index-v1'"
    expected_pack: "search.elasticsearch"
    expected_decision: "deny"
    reason: "Deletes old index"
  - command: "curl -X POST 'http://localhost:9200/prod-index-v2/_delete_by_query' -H 'Content-Type: application/json' -d '{\"query\":{\"match\":{\"status\":\"inactive\"}}}'"
    expected_pack: "search.elasticsearch"
    expected_decision: "deny"
    reason: "Deletes matching documents"
